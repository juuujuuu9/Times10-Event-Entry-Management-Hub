# QR Check-In Edge Case Test Plan

Single source of truth for API edge-case tests, CSV import validation, and critical manual paths.

---

## Quick Reference

### NPM Scripts

```bash
# 1. Start dev server WITH auth bypass (separate terminal)
BYPASS_AUTH_FOR_TESTS=true npm run dev

# 2. Run API edge case tests (test script sends X-Test-Mode: 1)
BYPASS_AUTH_FOR_TESTS=true npm run test:edge-cases

# Specify a different URL (use -- to pass args through npm)
BYPASS_AUTH_FOR_TESTS=true npm run test:edge-cases -- http://localhost:4321

# Generate 15 test CSV files for manual import testing
npm run test:generate-csvs
```

### Environment

- **BYPASS_AUTH_FOR_TESTS=true** — Must be set when starting the dev server AND when running tests. Middleware bypasses staff auth when this env is set and request has `X-Test-Mode: 1` header. Dev-only.
- Dev server: `npm run dev` (default http://localhost:4321)
- DB: Neon/similar; ensure setup complete
- Resend: Optional for email tests; unconfigured returns `configured: false`

---

## Automated API Tests

| # | Test | Endpoint | Expected |
|---|------|----------|----------|
| 1 | Checkin: Invalid QR format | POST /api/checkin | 400, 404, or 429 |
| 2 | Checkin: Missing QR data | POST /api/checkin | 400 or 429 |
| 3 | Import: Missing file | POST /api/attendees/import | 400 |
| 4 | Import: Missing eventId | POST /api/attendees/import | 400 |
| 5 | Email: Check configuration | GET /api/send-email | 200 |
| 6 | Email: Missing attendeeId | POST /api/send-email | 400 |
| 7 | Bulk send: Empty attendee list | POST /api/attendees/send-bulk-qr | 400 |
| 8 | Bulk send: Missing eventId | POST /api/attendees/send-bulk-qr | 400 |
| 9 | Bulk send: Non-existent event | POST /api/attendees/send-bulk-qr | 404 |
| 10 | Webhook: Missing auth | POST /api/webhooks/entry | 401 |
| 11 | Webhook: Wrong auth | POST /api/webhooks/entry | 401 |
| 12 | Refresh QR: Missing ID | POST /api/attendees/refresh-qr | 400 |
| 13 | Refresh QR: Non-existent attendee | POST /api/attendees/refresh-qr | 404 |
| 14 | Bulk refresh: Missing confirmation | POST /api/attendees/refresh-qr-bulk | 400 |
| 15 | Import: Non-existent event | POST /api/attendees/import | 404 |
| 16 | Import: Headers only (empty rows) | POST /api/attendees/import | 400 or 404 |
| 17 | Import: Invalid eventId format | POST /api/attendees/import | 400, 404, or 500 |
| 18 | Checkin: Malformed UUID in QR | POST /api/checkin | 400, 404, or 429 |
| 19 | Checkin: Valid format but wrong token | POST /api/checkin | 400, 401, 404, or 429 |

---

## CSV Test Files

Generated by `npm run test:generate-csvs` into `test-csvs/`. Use for manual import testing.

| File | Description | Expected Result |
|------|-------------|-----------------|
| valid-simple.csv | 3 valid attendees | imported: 3, skipped: 0 |
| empty.csv | Headers only (no data) | 400 error |
| missing-email.csv | Mix valid/invalid emails | 1 imported, invalid rows skipped |
| duplicates.csv | Same email 3 times | 1 imported, 2 skipped (first wins) |
| special-chars.csv | Accents, emoji, quotes | All 5 imported correctly |
| csv-injection.csv | Formula injection attempts | Stored as literal text |
| long-fields.csv | Very long names/emails | 2 imported (or skip if DB limit) |
| extra-columns.csv | Extra phone, dietary, etc. | 2 imported, extras in source_data |
| header-variants.csv | Different header names | 2 imported (column mapping) |
| quoted-fields.csv | Commas inside quoted | Parsed correctly |
| bom-utf8.csv | UTF-8 BOM | Header normalized, 1 imported |
| windows-line-endings.csv | CRLF | 2 imported |
| mixed-whitespace.csv | Leading/trailing spaces | Trimmed correctly |
| case-insensitive-headers.csv | EMAIL, FIRST_NAME | 2 imported |
| empty-rows.csv | Blank lines between data | 3 imported (blanks ignored) |

---

## Critical Manual Paths

### Path 1: Happy Path

1. Create event (Admin → Events → New)
2. Import `test-csvs/valid-simple.csv`
3. Send bulk email to imported attendees
4. Open email, view QR
5. Scan with staff phone on /scanner → Green "Checked in"

### Path 2: Double Check-In

1. Check in an attendee (green)
2. Immediately scan same QR again
3. Verify: Yellow "Already checked in", not red error

### Path 3: Invalid QR Handling

1. Scan any valid QR
2. Change one character in payload (e.g. in devtools or mock)
3. Verify: Red "Invalid QR" message, graceful handling

### Path 4: CSV Duplicate Detection

1. Import `test-csvs/duplicates.csv` → 1 imported, 2 skipped
2. Import same file again → 0 imported, 3 skipped
3. Verify duplicates detected across imports (event + email)

### Path 5: Partial Email Failure

1. Import CSV with mix of valid/invalid emails
2. Send bulk email
3. Verify: Results show sent/failed counts with error details (up to 5 errors returned)

### Path 6: Offline Check-In

1. Turn off WiFi on staff phone
2. Scan valid QR → Should queue check-in (green)
3. Turn WiFi back on → Should sync successfully
4. Verify attendee shows checked in in admin

---

## Production Blockers Checklist

| Issue | Severity | Status |
|------|----------|--------|
| Invalid QR codes being generated | Critical | Fixed |
| Duplicate detection failing | Critical | Verify Path 4 |
| Email blast to wrong recipients | Critical | Verify Path 5 |
| Offline check-ins not syncing | Critical | Verify Path 6 |
| Race conditions on concurrent check-ins | Critical | Manual test multi-staff |

---

## Environment Requirements

- **Dev server**: Required for `npm run test:edge-cases`
- **Database**: Neon (or similar); migrations applied
- **Auth**: Google configured for staff; or BYPASS_AUTH_FOR_TESTS for automated tests
- **Resend**: Optional; email tests report `configured: false` if unset
